<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>×¡×¤×¨ ×”××ª×›×•× ×™× ×©×œ×™</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '375px',
                    },
                    padding: {
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                        'safe-top': 'env(safe-area-inset-top)',
                    },
                    margin: {
                        'safe-top': 'env(safe-area-inset-top)',
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons (Script version for browser) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase Compat SDKs (Browser friendly) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-black text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAyduZJV4ShlLFRSgjik7RX8bwxPnAVn_0",
            authDomain: "recipe-book-83c89.firebaseapp.com",
            databaseURL: "https://recipe-book-83c89.firebaseio.com",
            projectId: "recipe-book-83c89",
            storageBucket: "recipe-book-83c89.appspot.com",
            messagingSenderId: "455704276627",
            appId: "1:455704276627:web:38a9fd87d9ac9ece11e766"
        };

        // --- Database Constants ---
        const TEST_DB_ID = "giyGyr4ALAPNLvLybbEOPXyHDMv2";
        const PROD_DB_ID = "YOUR_REAL_DB_ID_HERE"; 

        const DEFAULT_CATEGORIES = ['×¢×™×§×¨×™×•×ª', '×—×œ×‘×™', '×ª×•×¡×¤×•×ª', '×¡×œ×˜×™×', '×××¤×™×', '×§×™× ×•×—×™×', '××¨×•×—×ª ×‘×•×§×¨', '××©×§××•×ª', '×©×•× ×•×ª'];
        const DEFAULT_CATEGORY = '×©×•× ×•×ª'; 

        // --- Initialize Firebase (Compat Mode for HTML) ---
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Icon Adapter (To make Lucide React code work in HTML) ---
        const Icon = ({ name, size = 24, className, ...props }) => {
            const iconData = window.lucide ? window.lucide.icons[name] : null;
            if (!iconData) return null;
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth={props.strokeWidth || 2} 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className} 
                    {...props}
                >
                    {iconData.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // Defining Icons used in your code
        const Plus = (p) => <Icon name="Plus" {...p} />;
        const Search = (p) => <Icon name="Search" {...p} />;
        const ArrowRight = (p) => <Icon name="ArrowRight" {...p} />;
        const Edit2 = (p) => <Icon name="Edit2" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const ChefHat = (p) => <Icon name="ChefHat" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Sparkles = (p) => <Icon name="Sparkles" {...p} />;
        const CheckCircle2 = (p) => <Icon name="CheckCircle2" {...p} />;
        const Circle = (p) => <Icon name="Circle" {...p} />;
        const ListChecks = (p) => <Icon name="ListChecks" {...p} />;
        const AlertCircle = (p) => <Icon name="AlertCircle" {...p} />;
        const Lock = (p) => <Icon name="Lock" {...p} />;
        const KeyRound = (p) => <Icon name="KeyRound" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const Upload = (p) => <Icon name="Upload" {...p} />;
        const FileText = (p) => <Icon name="FileText" {...p} />;
        const Share = (p) => <Icon name="Share" {...p} />;
        const Mail = (p) => <Icon name="Mail" {...p} />;
        const Tag = (p) => <Icon name="Tag" {...p} />;
        const ShieldCheck = (p) => <Icon name="ShieldCheck" {...p} />;
        const Database = (p) => <Icon name="Database" {...p} />;
        const CloudUpload = (p) => <Icon name="CloudUpload" {...p} />;
        const ChevronDown = (p) => <Icon name="ChevronDown" {...p} />;

        // --- Global Styles (Exact Copy) ---
        const GlobalStyles = () => (
          <style>
            {`
              @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap');
              body { font-family: 'Rubik', sans-serif; background-color: #000; color: #e5e7eb; overflow-x: hidden; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
              
              /* Mobile adjustments */
              input, textarea, select { font-size: 16px !important; } /* Prevent iOS zoom */
              
              .glass-panel {
                background: rgba(20, 20, 20, 0.85);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
              }
              .gradient-text {
                background: linear-gradient(135deg, #fb7185 0%, #fb923c 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              .gradient-bg {
                background: linear-gradient(135deg, #e11d48 0%, #ea580c 100%);
              }
              .checkbox-transition {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              }
              @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
              }
              .animate-shake {
                animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
              }
              @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
              }
              .animate-float {
                animation: float 3s ease-in-out infinite;
              }
              .no-scrollbar::-webkit-scrollbar {
                display: none;
              }
              .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
              }
              
              @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
              @keyframes slideInBottom { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
              @keyframes slideUpSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }
              @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
              @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

              .animate-in { animation-duration: 0.4s; animation-fill-mode: forwards; }
              .fade-in { animation-name: fadeIn; }
              .slide-in-from-bottom-8 { animation-name: slideInBottom; }
              .slide-up-sheet { animation: slideUpSheet 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
              .zoom-in-95 { animation-name: zoomIn; }
              .animate-spin-slow { animation: spin 3s linear infinite; }
              
              /* Bottom Sheet specific styles */
              .modal-backdrop {
                  background-color: rgba(0,0,0,0.6);
                  backdrop-filter: blur(4px);
              }
            `}
          </style>
        );

        // --- Helpers ---
        const normalizeCategories = (recipe) => {
            if (recipe.categories && Array.isArray(recipe.categories)) return recipe.categories;
            if (recipe.category) return [recipe.category];
            return [DEFAULT_CATEGORY];
        };

        // --- Components ---

        const SplashScreen = ({ onFinish }) => {
          const [visible, setVisible] = useState(true);

          useEffect(() => {
            const timer = setTimeout(() => {
              setVisible(false);
              setTimeout(onFinish, 500); 
            }, 2500);
            return () => clearTimeout(timer);
          }, [onFinish]);

          return (
            <div className={`fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-500 ${visible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
              <div className="relative">
                <div className="absolute inset-0 bg-rose-500/20 blur-[60px] rounded-full animate-pulse"></div>
                <div className="relative z-10 p-6 gradient-bg rounded-[2rem] shadow-2xl shadow-rose-500/30 animate-float">
                   <ChefHat size={64} className="text-white" strokeWidth={1.5} />
                </div>
              </div>
              <h1 className="mt-8 text-4xl font-black text-white tracking-tight">
                ×”××ª×›×•× ×™× <span className="gradient-text">×©×œ×™</span>
              </h1>
              <p className="mt-3 text-gray-500 text-lg tracking-wide">×”×¡×¤×¨ ×”××©×¤×—×ª×™</p>
            </div>
          );
        };

        const Toast = ({ show, message, type, onClose }) => {
          if (!show) return null;
          const isError = type === 'error';
          const bgColor = isError ? 'bg-red-500/10 border-red-500/20' : 'bg-emerald-500/10 border-emerald-500/20';
          const textColor = isError ? 'text-red-400' : 'text-emerald-400';
          const Icon = isError ? AlertCircle : CheckCircle2;

          return (
            <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[80] flex items-center gap-3 px-6 py-4 rounded-2xl border backdrop-blur-md shadow-xl animate-in fade-in duration-300 ${bgColor} w-[90%] max-w-sm justify-between shadow-2xl`}>
              <div className="flex items-center gap-3">
                  <Icon className={textColor} size={24} />
                  <span className="text-white font-medium text-sm md:text-base">{message}</span>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors p-1"><X size={18} /></button>
            </div>
          );
        };

        // Mobile Optimized Modal (Bottom Sheet style on Mobile)
        const Modal = ({ isOpen, onClose, children }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center sm:p-4 modal-backdrop animate-in fade-in duration-300">
              <div className="absolute inset-0" onClick={onClose} />
              
              <div className="relative w-full sm:max-w-md bg-[#1a1a1a] rounded-t-[2.5rem] sm:rounded-[2rem] p-6 pb-safe-bottom border-t sm:border border-white/10 shadow-2xl z-10 overflow-hidden animate-in slide-up-sheet sm:zoom-in-95 duration-300 max-h-[85vh] overflow-y-auto">
                {/* Drag handle for mobile */}
                <div className="w-12 h-1.5 bg-gray-700 rounded-full mx-auto mb-6 sm:hidden opacity-50" />
                
                <div className="absolute top-0 right-0 w-32 h-32 bg-rose-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                <div className="relative z-10">{children}</div>
              </div>
            </div>
          );
        };

        const SecurityModal = ({ isOpen, step, onClose, onConfirm }) => {
            if (!isOpen) return null;
            
            let question = "";
            let subtext = "";
            if (step === 1) { question = "×”×× ××ª×” ×¢×“×™?"; }
            else if (step === 2) { question = "×‘×˜×•×—? ××‘×œ ×‘×××ª?"; }
            else if (step === 3) { question = "××–×”×¨×ª ××¤×ª×—×™×!"; subtext = "×¤×¢×•×œ×” ×–×• ×¢×œ×•×œ×” ×œ××—×•×§ × ×ª×•× ×™×. ×× ××™× ×š ×”××¤×ª×—, ×¢×¦×•×¨ ×¢×›×©×™×•."; }
            
            return (
                <Modal isOpen={isOpen} onClose={onClose}>
                    <div className="text-center pb-4">
                        <div className="mx-auto w-16 h-16 bg-rose-500/10 rounded-full flex items-center justify-center mb-4">
                            <ShieldCheck size={32} className="text-rose-500" />
                        </div>
                        <h3 className="text-2xl font-black text-white mb-2">×‘×“×™×§×ª ××‘×˜×—×” ({step}/3)</h3>
                        <p className="text-lg text-gray-200 mb-2 font-bold">{question}</p>
                        {subtext && <p className="text-sm text-rose-400 mb-6 bg-rose-500/10 p-3 rounded-xl border border-rose-500/20">{subtext}</p>}
                        {!subtext && <div className="h-6 mb-6"></div>}
                        
                        <div className="flex flex-col sm:flex-row gap-3 justify-center">
                            <button onClick={onConfirm} className="w-full sm:w-auto px-8 py-4 rounded-2xl bg-gradient-to-r from-rose-600 to-orange-500 text-white font-bold shadow-lg shadow-rose-900/20 active:scale-95 transition-transform text-lg">×›×Ÿ, ×× ×™ ×¢×“×™</button>
                            <button onClick={onClose} className="w-full sm:w-auto px-8 py-4 rounded-2xl bg-[#2a2a2a] text-gray-400 font-medium active:scale-95 transition-transform">×‘×™×˜×•×œ</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const ConfirmationContent = ({ title, message, onConfirm, onClose }) => (
            <React.Fragment>
                <h3 className="text-2xl font-bold text-white mb-3 pr-2">{title}</h3>
                <p className="text-gray-400 mb-8 text-lg font-light leading-relaxed pr-2">{message}</p>
                <div className="flex flex-col-reverse sm:flex-row gap-3 sm:justify-end">
                    <button onClick={onClose} className="w-full sm:w-auto px-6 py-3.5 rounded-2xl bg-[#2a2a2a] text-gray-300 font-medium active:scale-95 transition-transform">×‘×™×˜×•×œ</button>
                    <button onClick={onConfirm} className="w-full sm:w-auto px-6 py-3.5 rounded-2xl bg-red-600 text-white font-bold shadow-lg shadow-red-900/20 active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <Trash2 size={20} />
                        ××—×§
                    </button>
                </div>
            </React.Fragment>
        );

        const SettingsContent = ({ onBackup, onRestore, onExportWord, onCloudBackup, isCloudLoading, onClose, isTestEnv }) => {
            return (
                <div className="flex flex-col gap-4 pb-2">
                    <div className="flex items-center justify-between">
                        <h3 className="text-2xl font-bold text-white">×”×’×“×¨×•×ª</h3>
                        <button onClick={onClose} className="p-2 bg-white/5 rounded-full"><X size={20} className="text-gray-400" /></button>
                    </div>
                    
                    {isTestEnv && (
                        <div className="bg-orange-500/10 border border-orange-500/30 p-4 rounded-2xl flex items-center gap-3">
                            <Database className="text-orange-400" size={24} />
                            <div>
                                <div className="text-orange-400 font-bold">××¦×‘ ×¡×‘×™×‘×ª ×‘×“×™×§×”</div>
                                <div className="text-orange-500/70 text-sm">×”×©×™× ×•×™×™× × ×©××¨×™× ×‘× ×¤×¨×“</div>
                            </div>
                        </div>
                    )}

                    <div className="space-y-3">
                        <h4 className="text-xs text-gray-500 font-bold uppercase tracking-wider mr-1">×¡× ×›×¨×•×Ÿ ×•×’×™×‘×•×™</h4>
                        <button onClick={onCloudBackup} disabled={isCloudLoading} className="w-full flex items-center gap-4 p-4 bg-[#252525] active:bg-[#303030] rounded-2xl transition-all text-right group disabled:opacity-50 border border-white/5 relative overflow-hidden">
                            <div className={`p-3 bg-rose-500/20 text-rose-400 rounded-xl ${isCloudLoading ? 'animate-pulse' : ''}`}><CloudUpload size={24} /></div>
                            <div>
                                <div className="text-white font-bold text-lg">×’×™×‘×•×™ ××œ× ×œ×¢× ×Ÿ</div>
                                <div className="text-gray-400 text-sm">×©××™×¨×” ×××•×‘×˜×—×ª ×‘×©×¨×ª</div>
                            </div>
                            {isCloudLoading && <div className="absolute inset-0 bg-black/20 flex items-center justify-center"><div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div></div>}
                        </button>
                    </div>

                    <div className="space-y-3">
                        <h4 className="text-xs text-gray-500 font-bold uppercase tracking-wider mr-1">×¤×¢×•×œ×•×ª ××§×•××™×•×ª</h4>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={onExportWord} className="flex flex-col items-center gap-3 p-4 bg-[#252525] active:bg-[#303030] rounded-2xl transition-all border border-white/5">
                                <div className="p-3 bg-indigo-500/20 text-indigo-400 rounded-xl"><FileText size={24} /></div>
                                <span className="text-white font-medium text-sm">×™×™×¦×•× Word</span>
                            </button>
                            <button onClick={onBackup} className="flex flex-col items-center gap-3 p-4 bg-[#252525] active:bg-[#303030] rounded-2xl transition-all border border-white/5">
                                <div className="p-3 bg-emerald-500/20 text-emerald-400 rounded-xl"><Download size={24} /></div>
                                <span className="text-white font-medium text-sm">×”×•×¨×“×ª ×§×•×‘×¥</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
          const [password, setPassword] = useState('');
          const [error, setError] = useState(false);

          const handleSubmit = (e) => {
            e.preventDefault();
            const pass = password.trim();
            if (pass === '×§×•×‘×™') {
                onLogin(PROD_DB_ID, 'prod');
            } else if (pass === '×˜×¡×˜') {
                onLogin(TEST_DB_ID, 'test');
            } else {
                setError(true);
                setTimeout(() => setError(false), 500);
            }
          };

          return (
            <div className="min-h-screen bg-black flex items-center justify-center p-6">
              <div className="max-w-md w-full bg-[#121212] p-8 rounded-[2.5rem] border border-white/5 shadow-2xl relative overflow-hidden animate-in fade-in zoom-in-95 duration-500">
                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-48 h-48 bg-rose-500/20 rounded-full blur-[80px] pointer-events-none"></div>
                <div className="relative z-10 flex flex-col items-center text-center">
                  <div className="w-24 h-24 gradient-bg rounded-3xl flex items-center justify-center shadow-lg shadow-rose-900/30 mb-8 rotate-3">
                    <Lock className="text-white" size={42} />
                  </div>
                  <h1 className="text-4xl font-black text-white mb-3">×‘×¨×•×›×™× ×”×‘××™×</h1>
                  <p className="text-gray-400 mb-10 text-lg">×¡×¤×¨ ×”××ª×›×•× ×™× ×©×œ ×”××©×¤×—×”</p>
                  <form onSubmit={handleSubmit} className="w-full space-y-5">
                    <div className="relative group">
                      <input 
                        type="password" 
                        value={password} 
                        onChange={(e) => setPassword(e.target.value)} 
                        className={`w-full bg-[#0a0a0a] text-white text-center text-xl font-bold py-5 rounded-2xl border outline-none transition-all placeholder-gray-700 ${error ? 'border-red-500/50 text-red-400 animate-shake' : 'border-white/10 focus:border-rose-500/50'}`} 
                        placeholder="×¡×™×¡××”" 
                        autoFocus 
                        inputMode="text"
                      />
                      <KeyRound className="absolute top-1/2 right-5 -translate-y-1/2 text-gray-600 group-focus-within:text-rose-500 transition-colors" size={24} />
                    </div>
                    <button type="submit" className="w-full gradient-bg text-white font-bold py-5 rounded-2xl shadow-xl shadow-rose-900/20 transition-all active:scale-[0.98] text-xl">×›× ×™×¡×”</button>
                  </form>
                  {error && <p className="text-red-400 mt-4 text-sm animate-in fade-in font-medium">×¡×™×¡××” ×©×’×•×™×”, × ×¡×• ×©×•×‘</p>}
                </div>
              </div>
            </div>
          );
        };

        const TextWithLinks = ({ text }) => {
          if (!text) return null;
          const urlRegex = /(https?:\/\/[^\s]+)/g;
          const parts = text.split(urlRegex);
          return (
            <span>
              {parts.map((part, i) => {
                if (part.match(urlRegex)) return <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-orange-400 hover:text-orange-300 underline underline-offset-4 decoration-orange-400/30 break-all font-medium transition-colors" onClick={(e) => e.stopPropagation()}>{part}</a>;
                return part;
              })}
            </span>
          );
        };

        const ChecklistView = ({ content }) => {
          const [checkedState, setCheckedState] = useState({});
          const lines = useMemo(() => content.split('\n'), [content]);
          const toggleLine = (index) => setCheckedState(prev => ({ ...prev, [index]: !prev[index] }));

          return (
            <div className="space-y-3 animate-in fade-in duration-500 pb-10">
              {lines.map((line, index) => {
                if (!line.trim()) return <div key={index} className="h-4" />;
                const isChecked = checkedState[index];
                return (
                  <div key={index} onClick={() => toggleLine(index)} className={`group flex items-start gap-4 p-5 rounded-2xl cursor-pointer border checkbox-transition select-none active:scale-[0.98] ${isChecked ? 'bg-[#121212] border-white/5 opacity-50' : 'bg-[#1a1a1a] border-white/10 shadow-md'}`}>
                    <div className={`mt-0.5 checkbox-transition ${isChecked ? 'text-emerald-500' : 'text-gray-500'}`}>
                      {isChecked ? <CheckCircle2 size={26} weight="fill" /> : <Circle size={26} />}
                    </div>
                    <div className={`text-lg leading-relaxed flex-1 checkbox-transition ${isChecked ? 'line-through text-gray-600' : 'text-gray-200'}`}>
                      <TextWithLinks text={line} />
                    </div>
                  </div>
                );
              })}
            </div>
          );
        };

        // --- Extracted Components (For stability and performance) ---

        const CategoryTabs = ({ selectedCategory, setSelectedCategory, allCategories }) => {
            const scrollContainerRef = useRef(null);

            // Auto-scroll selected category into view
            useEffect(() => {
                const container = scrollContainerRef.current;
                if (!container) return;
                
                const activeBtn = container.querySelector('[data-active="true"]');
                if (activeBtn) {
                    activeBtn.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest',
                        inline: 'center'
                    });
                }
            }, [selectedCategory]);

            return (
                <div className="sticky top-[135px] z-20 bg-black/95 backdrop-blur-md pb-3 pt-1 border-b border-white/5">
                    {/* Visual Scroll Hints (Gradients) */}
                    <div className="absolute right-0 top-0 bottom-0 w-12 bg-gradient-to-l from-black to-transparent pointer-events-none z-10 md:hidden" />
                    <div className="absolute left-0 top-0 bottom-0 w-12 bg-gradient-to-r from-black to-transparent pointer-events-none z-10 md:hidden" />
                    
                    <div 
                        ref={scrollContainerRef} 
                        className="max-w-3xl mx-auto px-4 overflow-x-auto no-scrollbar flex gap-3 pr-4 pl-4 snap-x"
                    >
                        <button 
                            onClick={() => setSelectedCategory('×”×›×œ')} 
                            data-active={selectedCategory === '×”×›×œ'}
                            className={`px-5 py-2.5 rounded-full whitespace-nowrap text-base font-bold transition-all shrink-0 snap-center ${selectedCategory === '×”×›×œ' ? 'gradient-bg text-white shadow-lg' : 'bg-[#1a1a1a] text-gray-400 border border-white/5 active:scale-95'}`}
                        >
                            ×”×›×œ
                        </button>
                        {allCategories.map(cat => (
                            <button 
                                key={cat} 
                                onClick={() => setSelectedCategory(cat)} 
                                data-active={selectedCategory === cat}
                                className={`px-5 py-2.5 rounded-full whitespace-nowrap text-base font-bold transition-all shrink-0 snap-center ${selectedCategory === cat ? 'gradient-bg text-white shadow-lg' : 'bg-[#1a1a1a] text-gray-400 border border-white/5 active:scale-95'}`}
                            >
                                {cat}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
          const [showSplash, setShowSplash] = useState(true);
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [dbId, setDbId] = useState(null);
          const [envMode, setEnvMode] = useState(''); 
           
          const [view, setView] = useState('list');
          const [recipes, setRecipes] = useState([]);
          const [searchQuery, setSearchQuery] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('×”×›×œ');
          const [activeRecipe, setActiveRecipe] = useState(null);
          const [modalState, setModalState] = useState({ isOpen: false, type: null, data: null });
          const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
          const [loading, setLoading] = useState(false);
          const [isCloudLoading, setIsCloudLoading] = useState(false);
           
          const [allCategories, setAllCategories] = useState(DEFAULT_CATEGORIES);
          const [securityModalOpen, setSecurityModalOpen] = useState(false);
          const [securityStep, setSecurityStep] = useState(1);

          // --- Firebase Sync ---
          useEffect(() => {
              if (!isAuthenticated || !db || !dbId) return;
              setLoading(true);
              const initAuth = async () => { try { await auth.signInAnonymously(); } catch (e) { console.error(e); } };
              initAuth();
              const unsubscribe = db.collection('notes').doc(dbId).collection('myNotes')
                  .onSnapshot((snapshot) => {
                      const loadedRecipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                      setRecipes(loadedRecipes);
                      setLoading(false);
                  }, () => setLoading(false));
              return () => unsubscribe();
          }, [isAuthenticated, dbId]);

          const handleLogin = (id, mode) => {
              setDbId(id);
              setEnvMode(mode);
              setIsAuthenticated(true);
              showToast(mode === 'test' ? '× ×›× ×¡ ×œ××¦×‘ ×‘×“×™×§×” ğŸ§ª' : '×‘×¨×•×›×™× ×”×‘××™× ×œ××©×¤×—×”! ğŸ‘¨â€ğŸ³', 'success');
          };

          const showToast = (message, type = 'success') => {
            setToast({ show: true, message, type });
            setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
          };

          // --- Actions ---
          const initiateCloudBackup = () => {
              setSecurityStep(1);
              setSecurityModalOpen(true);
              setModalState(prev => ({ ...prev, isOpen: false })); 
          };

          const handleSecurityConfirm = () => {
              if (securityStep < 3) {
                  setSecurityStep(prev => prev + 1);
              } else {
                  setSecurityModalOpen(false);
                  performCloudBackup();
              }
          };

          const performCloudBackup = async () => {
              setIsCloudLoading(true);
              try {
                  if (!auth.currentUser) await auth.signInAnonymously();
                  await db.collection('backups').doc('family_backup').set({
                      recipes: recipes,
                      categories: allCategories,
                      updatedAt: new Date().toISOString(),
                      backupBy: dbId
                  });
                  showToast("×”×’×™×‘×•×™ ×‘×•×¦×¢ ×‘×”×¦×œ×—×”!", "success");
              } catch (e) {
                  console.error(e);
                  showToast("×©×’×™××” ×‘×’×™×‘×•×™", "error");
              } finally {
                  setIsCloudLoading(false);
              }
          };

          const handleAddCategory = (newCat) => {
              if (!newCat.trim()) return;
              if (allCategories.includes(newCat.trim())) { showToast('×§×™×™× ×›×‘×¨', 'error'); return; }
              setAllCategories(prev => [...prev, newCat.trim()]);
              showToast('×§×˜×’×•×¨×™×” × ×•×¡×¤×”', 'success');
          };

          const handleSave = async (recipe) => {
            if (!db || !dbId) return;
            try {
                const recipeData = {
                    title: recipe.title,
                    content: recipe.content,
                    categories: recipe.categories || [DEFAULT_CATEGORY],
                    updatedAt: new Date().toISOString()
                };
                if (recipe.id) await db.collection('notes').doc(dbId).collection('myNotes').doc(recipe.id).update(recipeData);
                else await db.collection('notes').doc(dbId).collection('myNotes').add(recipeData);
                showToast('× ×©××¨ ×‘×”×¦×œ×—×”! ğŸ˜‹', 'success');
                setView('list');
                setActiveRecipe(null);
            } catch (e) { showToast("×©×’×™××” ×‘×©××™×¨×”", "error"); }
          };

          const confirmDelete = async () => {
            const id = modalState.data;
            if (!db || !dbId || !id) return;
            try {
                await db.collection('notes').doc(dbId).collection('myNotes').doc(id).delete();
                if (activeRecipe?.id === id) { setView('list'); setActiveRecipe(null); }
                setModalState(prev => ({ ...prev, isOpen: false }));
                showToast('× ××—×§ ×‘×”×¦×œ×—×”', 'info');
            } catch (e) { showToast("×©×’×™××” ×‘××—×™×§×”", "error"); }
          };

          const handleBackup = () => {
              const dataStr = JSON.stringify({ recipes, categories: allCategories }, null, 2);
              const link = document.createElement('a');
              link.href = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
              link.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
              link.click();
          };

          const handleExportWord = () => {
              if (recipes.length === 0) { showToast('××™×Ÿ × ×ª×•× ×™×', 'error'); return; }
              const escapeHtml = (text) => text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
              let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>×¡×¤×¨ ××ª×›×•× ×™×</title><style>body{font-family:Arial;direction:rtl;text-align:right}</style></head><body><h1 style="text-align:center;color:#e11d48">×¡×¤×¨ ×”××ª×›×•× ×™× ×©×œ×™</h1>`;
              recipes.forEach(r => {
                  html += `<div style="border:1px solid #ddd;padding:15px;margin-bottom:20px"><h2 style="color:#e11d48">${escapeHtml(r.title)}</h2><p><b>×§×˜×’×•×¨×™×•×ª:</b> ${normalizeCategories(r).join(', ')}</p><p style="white-space:pre-wrap">${escapeHtml(r.content).replace(/\n/g, '<br/>')}</p></div>`;
              });
              html += "</body></html>";
              const link = document.createElement('a');
              link.href = URL.createObjectURL(new Blob(['\ufeff', html], { type: 'application/msword' }));
              link.download = `recipes_${new Date().toLocaleDateString('he-IL').replace(/\./g, '-')}.doc`;
              link.click();
          };

          const handleShareEmail = (recipe) => {
              const cats = normalizeCategories(recipe).join(', ');
              window.location.href = `mailto:?subject=${encodeURIComponent(recipe.title)}&body=${encodeURIComponent(`${recipe.title}\n(${cats})\n\n${recipe.content}`)}`;
          };

          const openDeleteModal = (id) => setModalState({ isOpen: true, type: 'delete', data: id });
          const openSettingsModal = () => setModalState({ isOpen: true, type: 'settings', data: null });
          const closeModal = () => setModalState({ ...modalState, isOpen: false });
          const startEdit = (recipe) => { setActiveRecipe(recipe); setView('edit'); };
          const startCreate = () => { setActiveRecipe({ title: '', content: '', categories: [] }); setView('create'); };
          const viewRecipe = (recipe) => { setActiveRecipe(recipe); setView('view'); };
          const goBack = () => { setView('list'); setActiveRecipe(null); };

          const filteredRecipes = useMemo(() => {
            return recipes.filter(r => {
                const matchesSearch = r.title.toLowerCase().includes(searchQuery.toLowerCase()) || r.content.toLowerCase().includes(searchQuery.toLowerCase());
                if (selectedCategory === '×”×›×œ') return matchesSearch;
                return matchesSearch && normalizeCategories(r).includes(selectedCategory);
            }).sort((a, b) => a.title.localeCompare(b.title, 'he'));
          }, [recipes, searchQuery, selectedCategory]);

          // --- UI Components ---

          const Header = () => (
            <div className="sticky top-0 z-30 glass-panel border-b border-white/5 pb-2 pt-safe-top transition-all duration-300">
              <div className="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
                {view === 'list' ? (
                  <>
                    <button onClick={openSettingsModal} className="p-3 bg-[#1a1a1a] rounded-full text-gray-400 active:scale-90 transition-transform"><Settings size={24} /></button>
                    <h1 className="text-2xl font-black text-white tracking-tight">×”××ª×›×•× ×™× <span className="gradient-text">×©×œ×™</span></h1>
                    <div className="w-10"></div> {/* Spacer for balance */}
                  </>
                ) : (
                  <>
                    <button onClick={goBack} className="p-3 bg-[#1a1a1a] rounded-full text-white active:scale-90 transition-transform"><ArrowRight className="transform rotate-180" size={24} /></button>
                    <div className="flex gap-3">
                      {view === 'view' && (
                        <>
                          <button onClick={() => startEdit(activeRecipe)} className="p-3 bg-[#1a1a1a] rounded-full text-blue-400 active:scale-90 transition-transform"><Edit2 size={22} /></button>
                          <button onClick={() => openDeleteModal(activeRecipe.id)} className="p-3 bg-[#1a1a1a] rounded-full text-red-400 active:scale-90 transition-transform"><Trash2 size={22} /></button>
                        </>
                      )}
                    </div>
                  </>
                )}
              </div>
              
              {view === 'list' && (
                  <div className="px-4 pb-2 max-w-3xl mx-auto">
                      <div className="relative">
                          <input type="text" placeholder="×—×™×¤×•×© ××”×™×¨..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-[#1a1a1a] text-white rounded-2xl py-3.5 pr-12 pl-4 focus:outline-none focus:ring-2 focus:ring-rose-500/30 border border-white/5 placeholder-gray-500 text-lg" />
                          <div className="absolute right-4 top-3.5 text-gray-500"><Search size={22} /></div>
                      </div>
                  </div>
              )}
            </div>
          );

          // Note: CategoryTabs removed from here and moved outside App to prevent re-render scroll jumping

          const RecipeForm = () => {
            const [title, setTitle] = useState(activeRecipe?.title || '');
            const [content, setContent] = useState(activeRecipe?.content || '');
            const [selectedCats, setSelectedCats] = useState(normalizeCategories(activeRecipe || {}));
            const [newCatName, setNewCatName] = useState('');
            const [showCatInput, setShowCatInput] = useState(false);

            const toggleCategory = (cat) => {
                setSelectedCats(prev => prev.includes(cat) ? prev.filter(c => c !== cat) : (prev.length < 2 ? [...prev, cat] : prev));
            };

            const addCat = (e) => {
                e.preventDefault();
                if (newCatName.trim()) {
                    handleAddCategory(newCatName);
                    if (selectedCats.length < 2) setSelectedCats(p => [...p, newCatName.trim()]);
                    setNewCatName(''); setShowCatInput(false);
                }
            };

            return (
              <div className="flex flex-col h-full bg-black">
                {/* Fixed Top Header for Form */}
                <div className="sticky top-0 z-40 bg-black/90 backdrop-blur-md border-b border-white/10 px-4 py-3 flex items-center justify-between pt-safe-top">
                    <button onClick={goBack} className="text-gray-400 font-medium px-2 py-2 hover:text-white transition-colors active:scale-95">×‘×™×˜×•×œ</button>
                    <h2 className="text-lg font-bold text-white">{activeRecipe?.id ? '×¢×¨×™×›×ª ××ª×›×•×Ÿ' : '××ª×›×•×Ÿ ×—×“×©'}</h2>
                    <button onClick={() => handleSave({ id: activeRecipe?.id, title, content, categories: selectedCats })} className="bg-white text-black font-bold px-5 py-2 rounded-full shadow-lg active:scale-95 transition-transform flex items-center gap-1">
                        <Save size={18} className="text-black" /> ×©××™×¨×”
                    </button>
                </div>

                <div className="flex-1 overflow-y-auto max-w-3xl mx-auto w-full p-5 animate-in fade-in slide-in-from-bottom-8">
                    <div className="mb-6">
                      <label className="block text-sm font-bold mb-2 text-gray-500">×›×•×ª×¨×ª</label>
                      <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full bg-[#1a1a1a] text-white text-2xl font-bold p-5 rounded-2xl border border-white/5 focus:border-rose-500/50 outline-none" placeholder="×œ××©×œ: ×¤×¡×˜×” ×‘×¨×•×˜×‘..." autoFocus />
                    </div>
                    <div className="mb-6">
                        <label className="block text-sm font-bold mb-2 text-gray-500">×§×˜×’×•×¨×™×•×ª (××§×¡×™××•× 2)</label>
                        <div className="flex flex-wrap gap-2.5">
                            {allCategories.map(cat => (
                                <button key={cat} onClick={() => toggleCategory(cat)} className={`px-4 py-2.5 rounded-xl text-sm font-bold transition-all border ${selectedCats.includes(cat) ? 'bg-rose-500/20 border-rose-500 text-rose-400' : 'bg-[#1a1a1a] border-white/5 text-gray-400'}`}>{cat}</button>
                            ))}
                            <button onClick={() => setShowCatInput(!showCatInput)} className="px-4 py-2.5 rounded-xl text-sm font-bold border border-dashed border-gray-600 text-gray-400 flex items-center gap-1"><Plus size={16} /> ×—×“×©</button>
                        </div>
                        {showCatInput && <div className="mt-3 flex gap-2"><input type="text" value={newCatName} onChange={e => setNewCatName(e.target.value)} className="flex-1 bg-[#1a1a1a] text-white p-3 rounded-xl border border-white/10" placeholder="×©× ×”×§×˜×’×•×¨×™×”..." /><button onClick={addCat} className="bg-emerald-600 text-white p-3 rounded-xl"><CheckCircle2 /></button></div>}
                    </div>
                    <div className="flex-1 pb-10">
                      <label className="block text-sm font-bold mb-2 text-gray-500">×ª×•×›×Ÿ ×”××ª×›×•×Ÿ</label>
                      <textarea value={content} onChange={(e) => setContent(e.target.value)} className="w-full min-h-[400px] bg-[#1a1a1a] text-white p-5 rounded-2xl border border-white/5 focus:border-rose-500/50 outline-none text-lg leading-relaxed resize-none" placeholder="×”××¦×¨×›×™× ×•××•×¤×Ÿ ×”×”×›× ×”..." />
                    </div>
                </div>
              </div>
            );
          };

          const RecipeDetail = () => {
            const [isChecklist, setIsChecklist] = useState(false);
            if (!activeRecipe) return null;
            return (
              <div className="max-w-3xl mx-auto p-5 pb-32 animate-in fade-in slide-in-from-bottom-8">
                <div className="bg-[#151515] rounded-[2rem] p-6 sm:p-8 border border-white/5 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-40 h-40 bg-rose-500/10 rounded-full blur-[50px] -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    <h2 className="text-3xl sm:text-4xl font-black text-white leading-tight mb-4 relative z-10">{activeRecipe.title}</h2>
                    <div className="flex flex-wrap gap-2 mb-8 relative z-10">
                        {normalizeCategories(activeRecipe).map((c, i) => <span key={i} className="px-3 py-1 bg-rose-500/10 text-rose-400 rounded-lg text-sm font-bold border border-rose-500/10">{c}</span>)}
                    </div>
                    <button onClick={() => setIsChecklist(!isChecklist)} className="w-full mb-6 py-3 bg-[#202020] rounded-xl text-gray-300 font-bold flex items-center justify-center gap-2 border border-white/5 active:scale-[0.98]">{isChecklist ? <FileText size={20} /> : <ListChecks size={20} />} {isChecklist ? '×ª×¦×•×’×ª ×˜×§×¡×˜' : '××¦×‘ ×”×›× ×” (×¦\'×§ ×œ×™×¡×˜)'}</button>
                    {isChecklist ? <ChecklistView content={activeRecipe.content} /> : <div className="text-lg text-gray-200 whitespace-pre-wrap leading-relaxed font-light"><TextWithLinks text={activeRecipe.content} /></div>}
                </div>
              </div>
            );
          };

          // --- Main Render ---
          if (showSplash) return <div dir="rtl"><GlobalStyles /><SplashScreen onFinish={() => setShowSplash(false)} /></div>;
          if (!isAuthenticated) return <div className="min-h-screen bg-black text-gray-200" dir="rtl"><GlobalStyles /><LoginScreen onLogin={handleLogin} /><Toast show={toast.show} message={toast.message} type={toast.type} onClose={() => setToast(prev => ({...prev, show: false}))} /></div>;

          return (
            <div className="min-h-screen bg-black text-gray-200 pb-safe-bottom" dir="rtl">
              <GlobalStyles />
              {/* Show Global Header ONLY when NOT editing/creating */}
              {(view !== 'edit' && view !== 'create') && <Header />}
              
              <main className="relative z-0 h-full">
                {view === 'list' && (
                    <>
                        <CategoryTabs selectedCategory={selectedCategory} setSelectedCategory={setSelectedCategory} allCategories={allCategories} />
                        <div className="max-w-3xl mx-auto p-4 grid gap-4 pb-32 animate-in fade-in duration-500 mt-2">
                          {loading ? (
                              <div className="text-center mt-20"><div className="mb-4 animate-spin-slow inline-block"><Sparkles size={40} className="text-rose-500" /></div><p className="text-gray-500">×˜×•×¢×Ÿ...</p></div>
                          ) : filteredRecipes.length === 0 ? (
                            <div className="text-center mt-20 px-10">
                              <div className="inline-block p-6 bg-[#151515] rounded-[2rem] mb-4"><ChefHat size={48} className="text-gray-700" /></div>
                              <p className="text-xl font-bold text-white mb-2">×¨×™×§ ×›××Ÿ...</p>
                              <p className="text-gray-500">×œ×—×¥ ×¢×œ ×”×¤×œ×•×¡ ×œ××˜×” ×›×“×™ ×œ×”×ª×—×™×œ</p>
                            </div>
                          ) : (
                            filteredRecipes.map(recipe => (
                              <div key={recipe.id} onClick={() => viewRecipe(recipe)} className="relative bg-[#1a1a1a] p-6 rounded-[2rem] border border-white/5 active:scale-[0.98] transition-transform">
                                <div className="flex justify-between items-start mb-3">
                                    <div className="flex gap-2">
                                        {normalizeCategories(recipe).slice(0, 2).map((c, i) => <span key={i} className="text-xs font-bold text-rose-400 bg-rose-500/10 px-2.5 py-1 rounded-md">{c}</span>)}
                                    </div>
                                </div>
                                <h3 className="text-2xl font-bold text-white mb-2 leading-tight">{recipe.title}</h3>
                                <p className="text-gray-400 line-clamp-2 text-base leading-relaxed pl-4 font-light">{recipe.content}</p>
                                <div className="absolute left-6 bottom-6 text-gray-700"><ArrowRight className="transform rotate-180" size={20} /></div>
                              </div>
                            ))
                          )}
                        </div>
                    </>
                )}
                {view === 'view' && <RecipeDetail />}
                {(view === 'edit' || view === 'create') && <RecipeForm />}
              </main>
               
              {view === 'list' && (
                <div className="fixed bottom-6 left-6 z-40">
                    <button onClick={startCreate} className="w-16 h-16 gradient-bg text-white rounded-full shadow-2xl shadow-rose-600/40 flex items-center justify-center active:scale-90 transition-transform"><Plus size={32} strokeWidth={3} /></button>
                </div>
              )}
               
              <Modal isOpen={modalState.isOpen} onClose={closeModal}>
                  {modalState.type === 'delete' && <ConfirmationContent title="××—×™×§×ª ××ª×›×•×Ÿ" message="×‘×˜×•×— ×©×¨×•×¦×™× ×œ××—×•×§? ××™ ××¤×©×¨ ×œ×©×—×–×¨ ××—×¨ ×›×š." onConfirm={confirmDelete} onClose={closeModal} />}
                  {modalState.type === 'settings' && <SettingsContent onBackup={handleBackup} onExportWord={handleExportWord} onCloudBackup={initiateCloudBackup} isCloudLoading={isCloudLoading} onClose={closeModal} isTestEnv={envMode === 'test'} />}
              </Modal>
              <SecurityModal isOpen={securityModalOpen} step={securityStep} onClose={() => setSecurityModalOpen(false)} onConfirm={handleSecurityConfirm} />
              <Toast show={toast.show} message={toast.message} type={toast.type} onClose={() => setToast(prev => ({...prev, show: false}))} />
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>