<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×¡×¤×¨ ×”××ª×›×•× ×™× ×©×œ×™</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons (Script version for browser) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase Compat SDKs (Browser friendly) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body class="bg-black text-gray-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase Configuration ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAyduZJV4ShlLFRSgjik7RX8bwxPnAVn_0",
            authDomain: "recipe-book-83c89.firebaseapp.com",
            databaseURL: "https://recipe-book-83c89.firebaseio.com",
            projectId: "recipe-book-83c89",
            storageBucket: "recipe-book-83c89.appspot.com",
            messagingSenderId: "455704276627",
            appId: "1:455704276627:web:38a9fd87d9ac9ece11e766"
        };

        // --- Database Constants ---
        const TEST_DB_ID = "giyGyr4ALAPNLvLybbEOPXyHDMv2";
        const PROD_DB_ID = "YOUR_REAL_DB_ID_HERE"; 

        const DEFAULT_CATEGORIES = ['×¢×™×§×¨×™×•×ª', '×—×œ×‘×™', '×ª×•×¡×¤×•×ª', '×¡×œ×˜×™×', '×××¤×™×', '×§×™× ×•×—×™×', '××¨×•×—×ª ×‘×•×§×¨', '××©×§××•×ª', '×©×•× ×•×ª'];
        const DEFAULT_CATEGORY = '×©×•× ×•×ª'; 

        // --- Initialize Firebase (Compat Mode for HTML) ---
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Icon Adapter (To make Lucide React code work in HTML) ---
        const Icon = ({ name, size = 24, className, ...props }) => {
            const iconData = window.lucide ? window.lucide.icons[name] : null;
            if (!iconData) return null;
            
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth={props.strokeWidth || 2} 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className} 
                    {...props}
                >
                    {iconData.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // Defining Icons used in your code
        const Plus = (p) => <Icon name="Plus" {...p} />;
        const Search = (p) => <Icon name="Search" {...p} />;
        const ArrowRight = (p) => <Icon name="ArrowRight" {...p} />;
        const Edit2 = (p) => <Icon name="Edit2" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const ChefHat = (p) => <Icon name="ChefHat" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Sparkles = (p) => <Icon name="Sparkles" {...p} />;
        const CheckCircle2 = (p) => <Icon name="CheckCircle2" {...p} />;
        const Circle = (p) => <Icon name="Circle" {...p} />;
        const ListChecks = (p) => <Icon name="ListChecks" {...p} />;
        const AlertCircle = (p) => <Icon name="AlertCircle" {...p} />;
        const Lock = (p) => <Icon name="Lock" {...p} />;
        const KeyRound = (p) => <Icon name="KeyRound" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const Upload = (p) => <Icon name="Upload" {...p} />;
        const FileText = (p) => <Icon name="FileText" {...p} />;
        const Share = (p) => <Icon name="Share" {...p} />;
        const Mail = (p) => <Icon name="Mail" {...p} />;
        const Tag = (p) => <Icon name="Tag" {...p} />;
        const ShieldCheck = (p) => <Icon name="ShieldCheck" {...p} />;
        const Database = (p) => <Icon name="Database" {...p} />;

        // --- Global Styles (Exact Copy) ---
        const GlobalStyles = () => (
          <style>
            {`
              @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap');
              body { font-family: 'Rubik', sans-serif; background-color: #000; color: #e5e7eb; }
              .glass-panel {
                background: rgba(30, 30, 30, 0.6);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
              }
              .gradient-text {
                background: linear-gradient(135deg, #fb7185 0%, #fb923c 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              .gradient-bg {
                background: linear-gradient(135deg, #e11d48 0%, #ea580c 100%);
              }
              .checkbox-transition {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
              }
              @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
              }
              .animate-shake {
                animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
              }
              @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
              }
              .animate-float {
                animation: float 3s ease-in-out infinite;
              }
              .no-scrollbar::-webkit-scrollbar {
                display: none;
              }
              .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
              }
              
              /* Added keyframes for animations used in JSX classes but defined in tailwind/external in react usually */
              @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
              @keyframes slideInBottom { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
              @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
              @keyframes slideInTop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
              @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

              .animate-in { animation-duration: 0.5s; animation-fill-mode: forwards; }
              .fade-in { animation-name: fadeIn; }
              .slide-in-from-bottom-8 { animation-name: slideInBottom; }
              .zoom-in-95 { animation-name: zoomIn; }
              .slide-in-from-top-4 { animation-name: slideInTop; }
              .animate-spin-slow { animation: spin 3s linear infinite; }
            `}
          </style>
        );

        // --- Helpers ---
        const normalizeCategories = (recipe) => {
            if (recipe.categories && Array.isArray(recipe.categories)) return recipe.categories;
            if (recipe.category) return [recipe.category];
            return [DEFAULT_CATEGORY];
        };

        // --- Components ---

        const SplashScreen = ({ onFinish }) => {
          const [visible, setVisible] = useState(true);

          useEffect(() => {
            const timer = setTimeout(() => {
              setVisible(false);
              setTimeout(onFinish, 500); 
            }, 2500);
            return () => clearTimeout(timer);
          }, [onFinish]);

          return (
            <div className={`fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-500 ${visible ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
              <div className="relative">
                <div className="absolute inset-0 bg-rose-500/20 blur-[60px] rounded-full animate-pulse"></div>
                <div className="relative z-10 p-6 gradient-bg rounded-[2rem] shadow-2xl shadow-rose-500/30 animate-float">
                   <ChefHat size={64} className="text-white" strokeWidth={1.5} />
                </div>
              </div>
              <h1 className="mt-8 text-4xl font-black text-white tracking-tight">
                ×”××ª×›×•× ×™× <span className="gradient-text">×©×œ×™</span>
              </h1>
              <p className="mt-3 text-gray-500 text-lg tracking-wide">×”×¡×¤×¨ ×”××©×¤×—×ª×™</p>
            </div>
          );
        };

        const Toast = ({ show, message, type, onClose }) => {
          if (!show) return null;
          const isError = type === 'error';
          const bgColor = isError ? 'bg-red-500/10 border-red-500/20' : 'bg-emerald-500/10 border-emerald-500/20';
          const textColor = isError ? 'text-red-400' : 'text-emerald-400';
          const Icon = isError ? AlertCircle : CheckCircle2;

          return (
            <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[80] flex items-center gap-3 px-6 py-4 rounded-2xl border backdrop-blur-md shadow-xl animate-in slide-in-from-top-4 fade-in duration-300 ${bgColor}`}>
              <Icon className={textColor} size={24} />
              <span className="text-white font-medium">{message}</span>
              <button onClick={onClose} className="mr-2 text-gray-400 hover:text-white transition-colors"><X size={18} /></button>
            </div>
          );
        };

        const Modal = ({ isOpen, onClose, children }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm animate-in fade-in duration-200">
              <div className="absolute inset-0" onClick={onClose} />
              <div className="relative bg-[#1a1a1a] rounded-[2rem] p-8 max-w-sm w-full border border-white/5 shadow-2xl z-10 overflow-hidden animate-in zoom-in-95 duration-300">
                <div className="absolute top-0 right-0 w-32 h-32 bg-rose-500/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
                <div className="relative z-10">{children}</div>
              </div>
            </div>
          );
        };

        const ConfirmationContent = ({ title, message, onConfirm, onClose }) => (
            <React.Fragment>
                <h3 className="text-2xl font-bold text-white mb-3">{title}</h3>
                <p className="text-gray-400 mb-8 text-lg font-light">{message}</p>
                <div className="flex gap-4 justify-end">
                    <button onClick={onClose} className="px-6 py-3 rounded-2xl text-gray-300 hover:bg-white/5 transition-all font-medium">×‘×™×˜×•×œ</button>
                    <button onClick={onConfirm} className="px-6 py-3 rounded-2xl bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold shadow-lg shadow-red-900/20 transition-all active:scale-95">××—×§</button>
                </div>
            </React.Fragment>
        );

        const SettingsContent = ({ onBackup, onRestore, onExportWord, onClose, isTestEnv }) => {
            return (
                <div className="flex flex-col gap-3">
                    <h3 className="text-2xl font-bold text-white mb-2">×”×’×“×¨×•×ª</h3>
                    
                    {isTestEnv && (
                        <div className="bg-orange-500/10 border border-orange-500/30 p-3 rounded-xl mb-2 flex items-center gap-3">
                            <Database className="text-orange-400" size={20} />
                            <div>
                                <div className="text-orange-400 font-bold text-sm">××¦×‘ ×¡×‘×™×‘×ª ×‘×“×™×§×”</div>
                                <div className="text-orange-500/70 text-xs">×”×©×™× ×•×™×™× × ×©××¨×™× ×‘××¡×“ ×‘×“×™×§×•×ª</div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white/5 p-4 rounded-2xl mb-2 border border-white/5">
                        <h4 className="text-sm text-gray-400 mb-3 font-bold uppercase tracking-wider">×’×™×‘×•×™ ×•×™×™×¦×•×</h4>
                        <button onClick={onExportWord} className="w-full flex items-center gap-4 p-3 hover:bg-white/5 rounded-xl transition-all text-right mb-2">
                            <div className="p-2 bg-indigo-500/20 text-indigo-400 rounded-lg"><FileText size={20} /></div>
                            <div className="text-white font-medium">×™×™×¦×•× ×œ×§×•×‘×¥ Word</div>
                        </button>
                        <button onClick={onBackup} className="w-full flex items-center gap-4 p-3 hover:bg-white/5 rounded-xl transition-all text-right mb-2">
                            <div className="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg"><Download size={20} /></div>
                            <div className="text-white font-medium">×©××™×¨×ª ×’×™×‘×•×™ ×œ××›×©×™×¨</div>
                        </button>
                    </div>
                    <button onClick={onClose} className="mt-2 w-full py-3 rounded-2xl text-gray-400 hover:bg-white/5 transition-colors">×¡×’×•×¨</button>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
          const [password, setPassword] = useState('');
          const [error, setError] = useState(false);

          const handleSubmit = (e) => {
            e.preventDefault();
            const pass = password.trim();
            if (pass === '×§×•×‘×™') {
                onLogin(PROD_DB_ID, 'prod');
            } else if (pass === '×˜×¡×˜') {
                onLogin(TEST_DB_ID, 'test');
            } else {
                setError(true);
                setTimeout(() => setError(false), 500);
            }
          };

          return (
            <div className="min-h-screen bg-black flex items-center justify-center p-4">
              <div className="max-w-md w-full bg-[#121212] p-8 rounded-[2.5rem] border border-white/5 shadow-2xl relative overflow-hidden animate-in fade-in zoom-in-95 duration-500">
                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-48 h-48 bg-rose-500/20 rounded-full blur-[80px] pointer-events-none"></div>
                <div className="relative z-10 flex flex-col items-center text-center">
                  <div className="w-20 h-20 gradient-bg rounded-3xl flex items-center justify-center shadow-lg shadow-rose-900/30 mb-6 rotate-3">
                    <Lock className="text-white" size={36} />
                  </div>
                  <h1 className="text-3xl font-black text-white mb-2">×‘×¨×•×›×™× ×”×‘××™×</h1>
                  <p className="text-gray-400 mb-8">×¡×¤×¨ ×”××ª×›×•× ×™× ×©×œ ×”××©×¤×—×”</p>
                  <form onSubmit={handleSubmit} className="w-full space-y-4">
                    <div className="relative">
                      <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className={`w-full bg-[#0a0a0a] text-white text-center text-lg font-medium p-5 rounded-2xl border outline-none transition-all placeholder-gray-700 ${error ? 'border-red-500/50 text-red-400 animate-shake focus:ring-1 focus:ring-red-500' : 'border-white/10 focus:border-rose-500/50 focus:ring-1 focus:ring-rose-500/50'}`} placeholder="×¡×™×¡××”" autoFocus />
                      <KeyRound className="absolute top-1/2 right-5 -translate-y-1/2 text-gray-600" size={20} />
                    </div>
                    <button type="submit" className="w-full gradient-bg text-white font-bold py-5 rounded-2xl shadow-xl shadow-rose-900/20 transition-all active:scale-[0.98] hover:brightness-110 text-lg">×›× ×™×¡×”</button>
                  </form>
                  {error && <p className="text-red-400 mt-4 text-sm animate-in fade-in">×¡×™×¡××” ×©×’×•×™×”, × ×¡×• ×©×•×‘</p>}
                </div>
              </div>
            </div>
          );
        };

        const TextWithLinks = ({ text }) => {
          if (!text) return null;
          const urlRegex = /(https?:\/\/[^\s]+)/g;
          const parts = text.split(urlRegex);
          return (
            <span>
              {parts.map((part, i) => {
                if (part.match(urlRegex)) return <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-orange-400 hover:text-orange-300 underline underline-offset-4 decoration-orange-400/30 break-all font-medium transition-colors" onClick={(e) => e.stopPropagation()}>{part}</a>;
                return part;
              })}
            </span>
          );
        };

        const ChecklistView = ({ content }) => {
          const [checkedState, setCheckedState] = useState({});
          const lines = useMemo(() => content.split('\n'), [content]);
          const toggleLine = (index) => setCheckedState(prev => ({ ...prev, [index]: !prev[index] }));

          return (
            <div className="space-y-3 animate-in fade-in duration-500">
              {lines.map((line, index) => {
                if (!line.trim()) return <div key={index} className="h-6" />;
                const isChecked = checkedState[index];
                return (
                  <div key={index} onClick={() => toggleLine(index)} className={`group flex items-start gap-4 p-4 rounded-2xl cursor-pointer border checkbox-transition select-none ${isChecked ? 'bg-[#151515] border-white/5 opacity-60' : 'bg-[#1a1a1a] border-white/10 hover:border-rose-500/30 hover:bg-[#202020] shadow-sm'}`}>
                    <div className={`mt-1 checkbox-transition ${isChecked ? 'text-emerald-500' : 'text-gray-500 group-hover:text-rose-400'}`}>
                      {isChecked ? <CheckCircle2 size={24} weight="fill" /> : <Circle size={24} />}
                    </div>
                    <div className={`text-lg leading-relaxed flex-1 checkbox-transition ${isChecked ? 'line-through text-gray-600 decoration-emerald-500/50' : 'text-gray-200'}`}>
                      <TextWithLinks text={line} />
                    </div>
                  </div>
                );
              })}
            </div>
          );
        };

        // --- Main App ---

        const App = () => {
          const [showSplash, setShowSplash] = useState(true);
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [dbId, setDbId] = useState(null);
          const [envMode, setEnvMode] = useState(''); // 'prod' or 'test'
           
          const [view, setView] = useState('list');
          const [recipes, setRecipes] = useState([]);
          const [searchQuery, setSearchQuery] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('×”×›×œ');
          const [activeRecipe, setActiveRecipe] = useState(null);
          const [modalState, setModalState] = useState({ isOpen: false, type: null, data: null });
          const [toast, setToast] = useState({ show: false, message: '', type: 'info' });
          const [loading, setLoading] = useState(false);
           
          // Custom Categories State
          const [allCategories, setAllCategories] = useState(DEFAULT_CATEGORIES);

          // --- Firebase Sync Logic ---
          useEffect(() => {
              if (!isAuthenticated || !db || !dbId) return;

              setLoading(true);
               
              // Anonymous Login to Firebase
              const initAuth = async () => {
                  try {
                      await auth.signInAnonymously();
                  } catch (e) {
                      console.error("Auth error", e);
                      showToast("×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª", "error");
                  }
              };
               
              initAuth();

              // Realtime listener
              // Compatibility Mode Adaptation: db.collection().doc().collection()
              const unsubscribe = db.collection('notes').doc(dbId).collection('myNotes')
                  .onSnapshot((snapshot) => {
                      const loadedRecipes = snapshot.docs.map(doc => ({
                          id: doc.id,
                          ...doc.data()
                      }));
                      setRecipes(loadedRecipes);
                      setLoading(false);
                  }, (error) => {
                      console.error("Error fetching recipes:", error);
                      showToast("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×", "error");
                      setLoading(false);
                  });

              return () => unsubscribe();
          }, [isAuthenticated, dbId]);

          const handleLogin = (id, mode) => {
              setDbId(id);
              setEnvMode(mode);
              setIsAuthenticated(true);
              showToast(mode === 'test' ? '× ×›× ×¡ ×œ××¦×‘ ×‘×“×™×§×” ğŸ§ª' : '×‘×¨×•×›×™× ×”×‘××™× ×œ××©×¤×—×”! ğŸ‘¨â€ğŸ³', 'success');
          };

          const showToast = (message, type = 'success') => {
            setToast({ show: true, message, type });
            setTimeout(() => setToast(prev => ({ ...prev, show: false })), 3000);
          };

          // --- Functions for Categories ---
          const handleAddCategory = (newCat) => {
              if (!newCat.trim()) return;
              if (allCategories.includes(newCat.trim())) {
                  showToast('×”×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª', 'error');
                  return;
              }
              setAllCategories(prev => [...prev, newCat.trim()]);
              showToast('×§×˜×’×•×¨×™×” × ×•×¡×¤×” (××§×•××™×ª)', 'success');
              // Note: Ideally, categories should also be stored in Firebase
          };

          // --- Actions ---

          const handleSave = async (recipe) => {
            if (!db || !dbId) return;
             
            try {
                const recipeData = {
                    title: recipe.title,
                    content: recipe.content,
                    categories: recipe.categories || [DEFAULT_CATEGORY],
                    updatedAt: new Date().toISOString()
                };

                if (recipe.id) {
                    // Update
                    await db.collection('notes').doc(dbId).collection('myNotes').doc(recipe.id).update(recipeData);
                } else {
                    // Create
                    await db.collection('notes').doc(dbId).collection('myNotes').add(recipeData);
                }
                 
                showToast('×”××ª×›×•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”! ğŸ˜‹', 'success');
                setView('list');
                setActiveRecipe(null);
            } catch (e) {
                console.error("Save error", e);
                showToast("×©×’×™××” ×‘×©××™×¨×ª ×”××ª×›×•×Ÿ", "error");
            }
          };

          const confirmDelete = async () => {
            const id = modalState.data;
            if (!db || !dbId || !id) return;

            try {
                await db.collection('notes').doc(dbId).collection('myNotes').doc(id).delete();
                if (activeRecipe?.id === id) { setView('list'); setActiveRecipe(null); }
                setModalState(prev => ({ ...prev, isOpen: false }));
                showToast('×”××ª×›×•×Ÿ × ××—×§', 'info');
            } catch (e) {
                console.error("Delete error", e);
                showToast("×©×’×™××” ×‘××—×™×§×ª ×”××ª×›×•×Ÿ", "error");
            }
          };

          // --- Local Backup (Json) and Word Export ---
          const handleBackup = () => {
              const dataStr = JSON.stringify({ recipes, categories: allCategories }, null, 2);
              const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
              const linkElement = document.createElement('a');
              linkElement.setAttribute('href', dataUri);
              linkElement.setAttribute('download', `backup_${envMode}_${new Date().toISOString().slice(0,10)}.json`);
              linkElement.click();
          };

          const handleExportWord = () => {
              if (recipes.length === 0) {
                  showToast('××™×Ÿ ××ª×›×•× ×™× ×œ×™×™×¦×•×', 'error');
                  return;
              }

              const escapeHtml = (text) => {
                  if (!text) return '';
                  return text
                      .replace(/&/g, "&amp;")
                      .replace(/</g, "&lt;")
                      .replace(/>/g, "&gt;")
                      .replace(/"/g, "&quot;")
                      .replace(/'/g, "&#039;");
              };

              let html = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
                <head>
                    <meta charset='utf-8'>
                    <title>×¡×¤×¨ ××ª×›×•× ×™×</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                        .recipe-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
                        .title { color: #e11d48; font-size: 24px; font-weight: bold; margin-bottom: 10px; }
                        .meta { color: #666; font-size: 14px; margin-bottom: 15px; }
                        .content { white-space: pre-wrap; line-height: 1.6; }
                    </style>
                </head>
                <body>
                    <h1 style="text-align:center; color:#e11d48; margin-bottom: 30px;">×¡×¤×¨ ×”××ª×›×•× ×™× ×©×œ×™</h1>
              `;

              recipes.forEach(r => {
                  const cats = normalizeCategories(r).join(', ');
                  const safeTitle = escapeHtml(r.title || '×œ×œ× ×›×•×ª×¨×ª');
                  const safeContent = escapeHtml(r.content || '').replace(/\n/g, '<br/>');
                  
                  html += `
                    <div class="recipe-card">
                        <div class="title">${safeTitle}</div>
                        <div class="meta"><b>×§×˜×’×•×¨×™×•×ª:</b> ${cats}</div>
                        <div class="content">${safeContent}</div>
                    </div>
                  `;
              });

              html += "</body></html>";
              
              const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = `×¡×¤×¨_××ª×›×•× ×™×_${new Date().toLocaleDateString('he-IL').replace(/\./g, '-')}.doc`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          };

          const handleShareEmail = (recipe) => {
              const cats = normalizeCategories(recipe).join(', ');
              window.location.href = `mailto:?subject=${encodeURIComponent(`××ª×›×•×Ÿ: ${recipe.title}`)}&body=${encodeURIComponent(`${recipe.title}\n(${cats})\n\n${recipe.content}\n\n× ×©×œ×— ×××¤×œ×™×§×¦×™×™×ª ×”××ª×›×•× ×™× ×©×œ×™`)}`;
          };

          const openDeleteModal = (id) => setModalState({ isOpen: true, type: 'delete', data: id });
          const openSettingsModal = () => setModalState({ isOpen: true, type: 'settings', data: null });
          const closeModal = () => setModalState({ ...modalState, isOpen: false });
          const startEdit = (recipe) => { setActiveRecipe(recipe); setView('edit'); };
          const startCreate = () => { setActiveRecipe({ title: '', content: '', categories: [] }); setView('create'); };
          const viewRecipe = (recipe) => { setActiveRecipe(recipe); setView('view'); };
          const goBack = () => { setView('list'); setActiveRecipe(null); };

          const filteredRecipes = useMemo(() => {
            return recipes.filter(r => {
                const matchesSearch = r.title.toLowerCase().includes(searchQuery.toLowerCase()) || r.content.toLowerCase().includes(searchQuery.toLowerCase());
                if (selectedCategory === '×”×›×œ') return matchesSearch;
                const rCats = normalizeCategories(r);
                return matchesSearch && rCats.includes(selectedCategory);
            }).sort((a, b) => a.title.localeCompare(b.title, 'he'));
          }, [recipes, searchQuery, selectedCategory]);

          // --- Render Sections ---

          const renderHeader = () => (
            <header className="sticky top-0 z-30 glass-panel border-b border-white/5 p-4 transition-all duration-300">
              <div className="max-w-3xl mx-auto flex items-center justify-between">
                {view === 'list' ? (
                  <div className="flex items-center gap-4 w-full">
                    <button onClick={openSettingsModal} className="p-3 bg-white/5 hover:bg-white/10 rounded-2xl text-gray-400 hover:text-white transition-all"><Settings size={24} /></button>
                    <div className="flex-1 flex justify-center"><h1 className="text-2xl font-black text-white hidden sm:block tracking-tight">×”××ª×›×•× ×™× <span className="gradient-text">×©×œ×™</span></h1></div>
                    <div className="relative w-full max-w-[45%] md:max-w-xs group">
                      <input type="text" placeholder="×—×™×¤×•×©..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-[#0a0a0a] text-white rounded-2xl py-3 pr-10 pl-4 focus:outline-none focus:ring-2 focus:ring-rose-500/30 border border-white/5 placeholder-gray-600 transition-all duration-300 group-hover:border-white/10" />
                      <div className="absolute right-3 top-3.5 text-gray-500 group-hover:text-rose-400 transition-colors"><Search size={20} /></div>
                    </div>
                  </div>
                ) : (
                  <div className="flex items-center gap-4 w-full">
                    <button onClick={goBack} className="p-3 -mr-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-full transition-all active:scale-90"><ArrowRight className="transform rotate-180" size={24} /></button>
                    <h1 className="text-xl font-bold truncate flex-1 text-white">{view === 'create' ? '×™×¦×™×¨×ª ××ª×›×•×Ÿ' : view === 'edit' ? '×¢×¨×™×›×”' : activeRecipe?.title}</h1>
                    {view === 'view' && (
                      <div className="flex gap-2">
                        <button onClick={() => handleShareEmail(activeRecipe)} className="p-3 text-gray-400 hover:text-blue-400 hover:bg-blue-500/10 rounded-full transition-all"><Mail size={22} /></button>
                        <button onClick={() => startEdit(activeRecipe)} className="p-3 text-gray-400 hover:text-rose-400 hover:bg-rose-500/10 rounded-full transition-all"><Edit2 size={22} /></button>
                        <button onClick={() => openDeleteModal(activeRecipe.id)} className="p-3 text-gray-400 hover:text-red-400 hover:bg-red-500/10 rounded-full transition-all"><Trash2 size={22} /></button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </header>
          );

          const CategoryTabs = () => (
              <div className="sticky top-[88px] z-20 bg-black/95 backdrop-blur-sm pb-2 pt-2 border-b border-white/5">
                <div className="max-w-3xl mx-auto px-4 overflow-x-auto no-scrollbar flex gap-2">
                    <button onClick={() => setSelectedCategory('×”×›×œ')} className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all ${selectedCategory === '×”×›×œ' ? 'gradient-bg text-white shadow-lg shadow-rose-900/20' : 'bg-white/5 text-gray-400 hover:bg-white/10'}`}>×”×›×œ</button>
                    {allCategories.map(cat => (
                        <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all ${selectedCategory === cat ? 'gradient-bg text-white shadow-lg shadow-rose-900/20' : 'bg-white/5 text-gray-400 hover:bg-white/10'}`}>{cat}</button>
                    ))}
                </div>
              </div>
          );

          const RecipeForm = ({ initialData, onSave, allCategories, onAddCategory }) => {
            const [title, setTitle] = useState(initialData.title);
            const [content, setContent] = useState(initialData.content);
            const [selectedCats, setSelectedCats] = useState(normalizeCategories(initialData));
            const [errors, setErrors] = useState({});
            const [isAddingCat, setIsAddingCat] = useState(false);
            const [newCatName, setNewCatName] = useState('');

            const toggleCategory = (cat) => {
                setSelectedCats(prev => {
                    if (prev.includes(cat)) return prev.filter(c => c !== cat);
                    if (prev.length >= 2) return prev;
                    return [...prev, cat];
                });
            };

            const handleAddNewCat = (e) => {
                e.preventDefault();
                if (newCatName.trim()) {
                    onAddCategory(newCatName);
                    if (selectedCats.length < 2) setSelectedCats(prev => [...prev, newCatName.trim()]);
                    setNewCatName('');
                    setIsAddingCat(false);
                }
            };

            const handleSubmit = (e) => {
              e.preventDefault();
              const newErrors = {};
              if (!title.trim()) newErrors.title = true;
              if (!content.trim()) newErrors.content = true;
              if (Object.keys(newErrors).length > 0) { setErrors(newErrors); showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª', 'error'); return; }
               
              onSave({ ...initialData, title, content, categories: selectedCats.length > 0 ? selectedCats : [DEFAULT_CATEGORY] });
            };

            return (
              <form onSubmit={handleSubmit} className="flex flex-col h-[calc(100vh-100px)] max-w-3xl mx-auto p-5 animate-in fade-in slide-in-from-bottom-8 duration-500">
                <div className="mb-6">
                  <label className="block text-sm font-semibold mb-2 pr-1 uppercase tracking-wider text-gray-500">×›×•×ª×¨×ª</label>
                  <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className={`w-full bg-[#151515] text-white text-2xl font-bold p-6 rounded-[1.5rem] border outline-none transition-all placeholder-gray-700 ${errors.title ? 'border-red-500/50' : 'border-white/5 focus:border-rose-500/50'}`} placeholder="×©× ×”×× ×”..." autoFocus />
                </div>
                 
                <div className="mb-6">
                    <div className="flex justify-between items-end mb-2 pr-1">
                        <label className="block text-sm font-semibold uppercase tracking-wider text-gray-500">×§×˜×’×•×¨×™×•×ª (×¢×“ 2)</label>
                    </div>
                     
                    <div className="flex flex-wrap gap-2">
                        {allCategories.map(cat => (
                            <button 
                                type="button" 
                                key={cat} 
                                onClick={() => toggleCategory(cat)} 
                                className={`px-4 py-2 rounded-xl text-sm font-bold transition-all border 
                                    ${selectedCats.includes(cat) 
                                        ? 'bg-rose-500/20 border-rose-500 text-rose-400' 
                                        : 'bg-[#151515] border-white/5 text-gray-500 hover:bg-white/5'}`}
                            >
                                {cat}
                            </button>
                        ))}
                         
                        {!isAddingCat ? (
                            <button 
                                type="button" 
                                onClick={() => setIsAddingCat(true)}
                                className="px-4 py-2 rounded-xl text-sm font-bold transition-all border border-dashed border-gray-600 text-gray-400 hover:border-gray-400 hover:text-white bg-transparent flex items-center gap-1"
                            >
                                <Plus size={14} /> ×—×“×©
                            </button>
                        ) : (
                           <div className="flex items-center gap-2 animate-in fade-in">
                                <input 
                                    type="text" 
                                    value={newCatName}
                                    onChange={(e) => setNewCatName(e.target.value)}
                                    placeholder="×©×..."
                                    className="bg-[#151515] text-white text-sm px-3 py-2 rounded-xl border border-white/10 outline-none w-32 focus:border-rose-500/50"
                                    autoFocus
                                />
                                <button type="button" onClick={handleAddNewCat} className="p-2 bg-emerald-500/20 text-emerald-400 rounded-lg hover:bg-emerald-500/30"><CheckCircle2 size={16} /></button>
                                <button type="button" onClick={() => setIsAddingCat(false)} className="p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30"><X size={16} /></button>
                           </div> 
                        )}
                    </div>
                </div>

                <div className="flex-1 mb-6 flex flex-col">
                  <label className="block text-sm font-semibold mb-2 pr-1 uppercase tracking-wider text-gray-500">×”×•×¨××•×ª ×•×¨×›×™×‘×™×</label>
                  <textarea value={content} onChange={(e) => setContent(e.target.value)} className={`flex-1 w-full bg-[#151515] text-gray-100 p-6 rounded-[1.5rem] border outline-none resize-none text-lg leading-8 transition-all placeholder-gray-700 ${errors.content ? 'border-red-500/50' : 'border-white/5 focus:border-rose-500/50'}`} placeholder="×¨×©×•× ×›×œ ×©×•×¨×” ×‘× ×¤×¨×“..." />
                </div>
                <button type="submit" className="w-full gradient-bg text-white font-bold py-5 rounded-[1.5rem] shadow-xl shadow-rose-900/20 flex items-center justify-center gap-3 transition-all active:scale-[0.98] hover:brightness-110 text-lg"><Save size={24} />×©××™×¨×”</button>
              </form>
            );
          };

          const RecipeDetail = ({ recipe }) => {
            const [isChecklistMode, setIsChecklistMode] = useState(false);
            const cats = normalizeCategories(recipe);

            return (
              <div className="max-w-3xl mx-auto p-4 animate-in fade-in zoom-in-95 duration-500 pb-24">
                <div className="fixed top-20 left-1/2 -translate-x-1/2 w-64 h-64 bg-rose-500/20 rounded-full blur-[100px] pointer-events-none z-0"></div>
                <div className="relative z-10 bg-black rounded-[2.5rem] p-8 md:p-10 border border-white/10 shadow-2xl min-h-[60vh]">
                  <div className="flex flex-col gap-2 mb-6 border-b border-white/10 pb-6">
                     <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <h2 className="text-3xl md:text-4xl font-black text-white leading-tight tracking-tight">{recipe.title}</h2>
                        <button onClick={() => setIsChecklistMode(!isChecklistMode)} className={`flex items-center gap-2 px-5 py-2.5 rounded-full font-medium transition-all duration-300 ${isChecklistMode ? 'bg-rose-500/20 text-rose-400 border border-rose-500/30' : 'bg-white/5 text-gray-400 hover:bg-white/10 hover:text-white border border-transparent'}`}><ListChecks size={20} />{isChecklistMode ? '××¦×‘ ×§×¨×™××”' : '××¦×‘ ×¦\'×§-×œ×™×¡×˜'}</button>
                    </div>
                    <div className="flex flex-wrap gap-2">
                        {cats.map((c, i) => (
                            <span key={i} className="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-white/5 text-rose-400 text-sm font-medium"><Tag size={14} /> {c}</span>
                        ))}
                    </div>
                  </div>
                  <div className="text-gray-200">{isChecklistMode ? <ChecklistView content={recipe.content} /> : <div className="whitespace-pre-wrap text-lg md:text-xl leading-relaxed font-light tracking-wide"><TextWithLinks text={recipe.content} /></div>}</div>
                </div>
              </div>
            );
          };

          const RecipeList = () => (
            <>
            <CategoryTabs />
            <div className="max-w-3xl mx-auto p-4 grid gap-5 pb-32 animate-in fade-in duration-500 mt-2">
              {loading ? (
                  <div className="text-center mt-20 flex flex-col items-center">
                      <div className="mb-4 animate-spin-slow"><Sparkles size={48} className="text-rose-500" /></div>
                      <p className="text-gray-400">×˜×•×¢×Ÿ ××ª×›×•× ×™× ××”×¢× ×Ÿ...</p>
                  </div>
              ) : filteredRecipes.length === 0 ? (
                <div className="text-center mt-20 flex flex-col items-center">
                  <div className="mb-8 p-8 bg-[#151515] rounded-[2rem] border border-white/5 shadow-inner relative overflow-hidden group">
                    <Sparkles size={48} className="text-gray-600 group-hover:text-rose-400 transition-colors" strokeWidth={1.5} />
                  </div>
                  <p className="text-2xl font-bold text-white mb-2">×œ× × ××¦××• ××ª×›×•× ×™×</p>
                  <p className="text-gray-500">×–×” ×”×–××Ÿ ×œ×™×¦×•×¨ ××©×”×• ×˜×¢×™×!</p>
                </div>
              ) : (
                filteredRecipes.map(recipe => (
                  <div key={recipe.id} onClick={() => viewRecipe(recipe)} className="group relative bg-[#121212] hover:bg-[#1a1a1a] p-6 rounded-[2rem] border border-white/5 hover:border-rose-500/30 cursor-pointer transition-all duration-300 hover:shadow-lg hover:shadow-rose-900/10 hover:-translate-y-1 active:scale-[0.99]">
                    <div className="absolute top-0 right-8 left-8 h-[1px] bg-gradient-to-r from-transparent via-rose-500 to-transparent opacity-0 group-hover:opacity-50 transition-opacity duration-500"></div>
                    <div className="flex justify-between items-start gap-4">
                      <div className="flex-1">
                        <div className="flex flex-wrap items-center gap-2 mb-2">
                            {normalizeCategories(recipe).slice(0, 2).map((c, i) => (
                                <span key={i} className="text-xs font-bold text-rose-500/80 uppercase tracking-wide bg-rose-500/10 px-2 py-0.5 rounded-md">{c}</span>
                            ))}
                            {normalizeCategories(recipe).length > 2 && <span className="text-xs text-gray-600">+{normalizeCategories(recipe).length - 2}</span>}
                        </div>
                        <h3 className="text-2xl font-bold text-gray-100 mb-3 group-hover:text-rose-400 transition-colors leading-tight">{recipe.title}</h3>
                        <p className="text-gray-400 line-clamp-2 text-base leading-relaxed pl-4 opacity-70 group-hover:opacity-100 transition-opacity font-light">{recipe.content}</p>
                      </div>
                      <div className="mt-1 text-gray-700 group-hover:text-rose-500/50 transition-colors p-2 bg-white/5 rounded-full group-hover:bg-white/10"><ArrowRight className="transform rotate-180" size={20} /></div>
                    </div>
                  </div>
                ))
              )}
            </div>
            </>
          );

          // --- Main Render ---

          if (showSplash) return <div dir="rtl"><GlobalStyles /><SplashScreen onFinish={() => setShowSplash(false)} /></div>;

          if (!isAuthenticated) return <div className="min-h-screen bg-black text-gray-200" dir="rtl"><GlobalStyles /><LoginScreen onLogin={handleLogin} /><Toast show={toast.show} message={toast.message} type={toast.type} onClose={() => setToast(prev => ({...prev, show: false}))} /></div>;

          return (
            <div className="min-h-screen bg-black text-gray-200" dir="rtl">
              <GlobalStyles />
              {renderHeader()}
              <main className="relative z-0">
                {view === 'list' && <RecipeList />}
                {view === 'view' && <RecipeDetail recipe={activeRecipe} />}
                {(view === 'edit' || view === 'create') && 
                    <RecipeForm 
                        initialData={activeRecipe} 
                        onSave={handleSave} 
                        allCategories={allCategories}
                        onAddCategory={handleAddCategory}
                    />
                }
              </main>
               
              {view === 'list' && (
                <button onClick={startCreate} className="fixed bottom-8 left-8 gradient-bg text-white rounded-[2rem] p-5 shadow-2xl shadow-rose-600/30 transition-all hover:scale-110 active:scale-95 z-40 group hover:rotate-90"><Plus size={32} strokeWidth={2.5} /></button>
              )}
               
              <Modal isOpen={modalState.isOpen} onClose={closeModal}>
                  {modalState.type === 'delete' && <ConfirmationContent title="××—×™×§×ª ××ª×›×•×Ÿ" message="×‘×˜×•×— ×©×¨×•×¦×™× ×œ××—×•×§? ××™ ××¤×©×¨ ×œ×”×ª×—×¨×˜ ××—×¨ ×›×š..." onConfirm={confirmDelete} onClose={closeModal} />}
                  {modalState.type === 'settings' && <SettingsContent onBackup={handleBackup} onExportWord={handleExportWord} onClose={closeModal} isTestEnv={envMode === 'test'} />}
              </Modal>
              <Toast show={toast.show} message={toast.message} type={toast.type} onClose={() => setToast(prev => ({...prev, show: false}))} />
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>